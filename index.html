<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Letter Challenge - Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    body { 
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-500 to-pink-500">
  <div id="app" class="flex items-center justify-center min-h-screen p-4"></div>

  <script>
    // Configurazione Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDWCEXrQNvMoSLCq-I9Eym-EQdRA58czJI",
      authDomain: "cittamulti.firebaseapp.com",
      databaseURL: "https://cittamulti-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cittamulti",
      storageBucket: "cittamulti.firebasestorage.app",
      messagingSenderId: "1037924560815",
      appId: "1:1037924560815:web:3ca426fb6f38243d40c95a"
    };

    // Inizializza Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Lista citt√† italiane
    const ITALIAN_CITIES = [
      "abbiategrasso", "acireale", "adria", "agrigento", "alessandria", "ancona", "andria", "arezzo",
      "ascoli piceno", "asti", "avellino", "bari", "barletta", "belluno", "benevento", "bergamo",
      "biella", "bologna", "bolzano", "brescia", "brindisi", "cagliari", "caltanissetta", "campobasso",
      "caserta", "catania", "catanzaro", "chieti", "como", "cosenza", "cremona", "crotone", "cuneo",
      "empoli", "enna", "fermo", "ferrara", "firenze", "foggia", "forl√¨", "frosinone", "genova",
      "gorizia", "grosseto", "imperia", "isernia", "la spezia", "l'aquila", "latina", "lecce",
      "lecco", "livorno", "lodi", "lucca", "macerata", "mantova", "massa", "matera", "messina",
      "milano", "modena", "monza", "napoli", "novara", "nuoro", "olbia", "oristano", "padova",
      "palermo", "parma", "pavia", "perugia", "pesaro", "pescara", "piacenza", "pisa", "pistoia",
      "pordenone", "potenza", "prato", "ragusa", "ravenna", "reggio calabria", "reggio emilia",
      "rieti", "rimini", "roma", "rovigo", "salerno", "sassari", "savona", "siena", "siracusa",
      "sondrio", "taranto", "teramo", "terni", "torino", "trapani", "trento", "treviso", "trieste",
      "udine", "varese", "venezia", "verbania", "vercelli", "verona", "vibo valentia", "vicenza",
      "viterbo"
    ];

    // Stato globale
    let gameState = 'login'; // 'login', 'lobby', 'playing'
    let playerName = '';
    let playerId = '';
    let roomId = '';
    let roomRef = null;
    let state = {
      letter: '',
      p1: { id: null, name: '', score: 0, answered: false },
      p2: { id: null, name: '', score: 0, answered: false },
      gameOver: false,
      winner: null,
      myAnswer: ''
    };

    // Controlla URL per stanza esistente
    const urlParams = new URLSearchParams(window.location.search);
    const urlRoomId = urlParams.get('room');

    if (urlRoomId) {
      roomId = urlRoomId;
    }

    // Render iniziale
    renderLogin();

    function renderLogin() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="bg-white p-8 rounded-2xl max-w-md w-full shadow-2xl">
          <h1 class="text-4xl font-bold text-center mb-2 text-purple-600">üèôÔ∏è Letter Challenge</h1>
          <p class="text-center text-gray-600 mb-6">Sfida un amico! Trova citt√† italiane</p>
          
          <div class="mb-6">
            <label class="block text-sm font-semibold mb-2 text-gray-700">Il tuo nome</label>
            <input
              type="text"
              id="nameInput"
              placeholder="Es: Mario"
              maxlength="15"
              class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500"
              onkeypress="if(event.key==='Enter') document.getElementById('roomInput').focus()"
            />
          </div>

          <div class="mb-6">
            <label class="block text-sm font-semibold mb-2 text-gray-700">Codice stanza (opzionale)</label>
            <input
              type="text"
              id="roomInput"
              placeholder="Lascia vuoto per creare nuova stanza"
              maxlength="6"
              value="${roomId}"
              class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 uppercase"
              onkeypress="if(event.key==='Enter') joinGame()"
            />
            <p class="text-xs text-gray-500 mt-1">Se vuoto, verr√† creata una nuova stanza</p>
          </div>

          <button
            onclick="joinGame()"
            class="bg-gradient-to-r from-purple-600 to-pink-600 text-white w-full py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition transform hover:scale-105"
          >
            Inizia a giocare! üéÆ
          </button>
        </div>
      `;
      
      document.getElementById('nameInput').focus();
    }

    function joinGame() {
      const nameInput = document.getElementById('nameInput').value.trim();
      const roomInput = document.getElementById('roomInput').value.trim().toUpperCase();

      if (!nameInput) {
        alert('Inserisci il tuo nome!');
        return;
      }

      playerName = nameInput;
      playerId = 'p' + Math.floor(Math.random() * 1000000);

      if (roomInput) {
        roomId = roomInput;
      } else {
        roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      }

      window.history.replaceState(null, null, `?room=${roomId}`);
      roomRef = db.ref(`rooms/${roomId}`);

      // Unisciti alla stanza
      roomRef.once('value', (snapshot) => {
        const data = snapshot.val();
        
        if (!data) {
          // Crea nuova stanza
          const letters = 'ABCDEFGHILMNOPQRSTUVXZ';
          const letter = letters[Math.floor(Math.random() * letters.length)];
          roomRef.set({
            letter,
            p1: { id: playerId, name: playerName, score: 0, answered: false },
            p2: { id: null, name: '', score: 0, answered: false },
            gameOver: false,
            winner: null
          });
        } else {
          // Unisciti alla stanza esistente
          if (!data.p1.id) {
            roomRef.child('p1').set({ id: playerId, name: playerName, score: 0, answered: false });
          } else if (!data.p2.id) {
            roomRef.child('p2').set({ id: playerId, name: playerName, score: 0, answered: false });
          } else if (data.p1.id === playerId) {
            // Riconnessione giocatore 1
          } else if (data.p2.id === playerId) {
            // Riconnessione giocatore 2
          } else {
            alert('Stanza piena! Riprova con un altro codice.');
            renderLogin();
            return;
          }
        }

        gameState = 'playing';
        roomRef.on('value', syncAndRender);
      });
    }

    function syncAndRender(snapshot) {
      if (!snapshot) return;
      const data = snapshot.val();
      if (!data) return;

      state.letter = data.letter;
      state.p1 = data.p1;
      state.p2 = data.p2;
      state.gameOver = data.gameOver;
      state.winner = data.winner;

      renderGame();
    }

    function checkAnswer() {
      const input = state.myAnswer.trim().toLowerCase();
      if (!input) {
        alert('Inserisci una citt√†!');
        return;
      }

      const isMyTurn = (state.p1.id === playerId && !state.p1.answered) ||
                       (state.p2.id === playerId && !state.p2.answered);
      if (!isMyTurn) return;

      const startsWithLetter = input[0].toUpperCase() === state.letter;
      const isCity = ITALIAN_CITIES.includes(input);

      const playerKey = state.p1.id === playerId ? 'p1' : 'p2';

      if (startsWithLetter && isCity) {
        roomRef.child(`${playerKey}/score`).transaction(s => (s || 0) + 1);
      }

      roomRef.child(`${playerKey}/answered`).set(true);

      setTimeout(() => {
        roomRef.once('value', (snap) => {
          const d = snap.val();
          if (d.p1.answered && d.p2.answered) {
            if (d.p1.score >= 5 || d.p2.score >= 5) {
              roomRef.update({
                gameOver: true,
                winner: d.p1.score >= 5 ? 'p1' : 'p2'
              });
            } else {
              const letters = 'ABCDEFGHILMNOPQRSTUVXZ';
              const newLetter = letters[Math.floor(Math.random() * letters.length)];
              roomRef.update({
                letter: newLetter,
                'p1/answered': false,
                'p2/answered': false
              });
            }
          }
        });
      }, 1500);
    }

    function resetGame() {
      const letters = 'ABCDEFGHILMNOPQRSTUVXZ';
      const letter = letters[Math.floor(Math.random() * letters.length)];
      roomRef.update({
        letter,
        'p1/score': 0,
        'p1/answered': false,
        'p2/score': 0,
        'p2/answered': false,
        gameOver: false,
        winner: null
      });
    }

    function copyRoomLink() {
      const link = window.location.href.split('&')[0];
      navigator.clipboard.writeText(link).then(() => {
        alert('Link copiato! Condividilo con un amico üéÆ');
      });
    }

    function leaveRoom() {
      if (confirm('Sei sicuro di voler uscire?')) {
        if (roomRef) roomRef.off();
        window.location.href = window.location.pathname;
      }
    }

    function renderGame() {
      const app = document.getElementById('app');
      const myPlayer = state.p1.id === playerId ? 'p1' : 'p2';
      const otherPlayer = myPlayer === 'p1' ? 'p2' : 'p1';

      if (state.gameOver) {
        const winnerPlayer = state[state.winner];
        app.innerHTML = `
          <div class="bg-white p-8 rounded-2xl max-w-md w-full text-center shadow-2xl">
            <h2 class="text-4xl font-bold mb-4">üèÜ</h2>
            <h3 class="text-2xl font-bold mb-2">${winnerPlayer.name} vince!</h3>
            <p class="text-xl mb-6 text-gray-600">
              ${state.p1.name} ${state.p1.score} - ${state.p2.score} ${state.p2.name}
            </p>
            <button onclick="resetGame()" class="bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-700 transition mb-3 w-full">
              üîÑ Rivincita
            </button>
            <button onclick="leaveRoom()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg font-semibold hover:bg-gray-300 transition w-full">
              üö™ Esci
            </button>
          </div>
        `;
        return;
      }

      app.innerHTML = `
        <div class="bg-white p-6 rounded-2xl max-w-md w-full shadow-2xl">
          <div class="flex justify-between items-center mb-4">
            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
              Stanza: ${roomId}
            </span>
            <button onclick="copyRoomLink()" class="text-sm text-purple-600 hover:text-purple-700 font-semibold">
              üìã Copia link
            </button>
          </div>

          <div class="flex justify-between mb-6 text-base">
            <div class="text-center flex-1">
              <div class="font-bold ${myPlayer === 'p1' ? 'text-purple-600' : 'text-gray-700'}">${state.p1.name || '...'}</div>
              <div class="text-2xl font-bold">${state.p1.score}</div>
            </div>
            <div class="text-2xl font-bold text-gray-400">-</div>
            <div class="text-center flex-1">
              <div class="font-bold ${myPlayer === 'p2' ? 'text-purple-600' : 'text-gray-700'}">${state.p2.name || '...'}</div>
              <div class="text-2xl font-bold">${state.p2.score}</div>
            </div>
          </div>

          <div class="text-7xl font-bold mb-4 text-center text-purple-600">${state.letter}</div>
          <p class="text-sm text-gray-600 mb-3 text-center">Trova una citt√† italiana con questa lettera</p>
          
          <input
            type="text"
            id="cityInput"
            placeholder="Es: Milano, Roma..."
            class="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 focus:outline-none focus:border-purple-500"
            onkeypress="if(event.key==='Enter') checkAnswer()"
            ${state[myPlayer].answered ? 'disabled' : ''}
          />
          
          <button
            onclick="checkAnswer()"
            class="bg-gradient-to-r from-pink-600 to-purple-600 text-white w-full py-3 rounded-lg font-semibold hover:from-pink-700 hover:to-purple-700 transition disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed"
            ${state[myPlayer].answered ? 'disabled' : ''}
          >
            ${state[myPlayer].answered ? '‚úÖ Risposta inviata' : 'Invia risposta'}
          </button>

          <div class="mt-4 pt-4 border-t text-center">
            <p class="text-sm ${state[otherPlayer].id ? 'text-green-600' : 'text-orange-600'}">
              ${state[otherPlayer].id ? `‚úÖ ${state[otherPlayer].name} √® connesso` : '‚è≥ In attesa dell\'avversario...'}
            </p>
            ${!state[otherPlayer].id ? `
              <button onclick="copyRoomLink()" class="mt-2 text-xs text-purple-600 hover:underline">
                Condividi il link per invitare qualcuno
              </button>
            ` : ''}
          </div>

          <button onclick="leaveRoom()" class="mt-4 w-full text-sm text-gray-500 hover:text-gray-700">
            üö™ Esci dalla stanza
          </button>
        </div>
      `;

      const input = document.getElementById('cityInput');
      if (input && !state[myPlayer].answered) {
        input.focus();
        input.addEventListener('input', e => state.myAnswer = e.target.value);
      }
    }
  </script>
</body>
</html>
