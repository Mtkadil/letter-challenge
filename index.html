<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Letter Challenge - Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    body { 
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-500 to-pink-500">
  <div id="app" class="flex items-center justify-center min-h-screen p-4"></div>

  <script>
    // Configurazione Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDWCEXrQNvMoSLCq-I9Eym-EQdRA58czJI",
      authDomain: "cittamulti.firebaseapp.com",
      databaseURL: "https://cittamulti-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cittamulti",
      storageBucket: "cittamulti.firebasestorage.app",
      messagingSenderId: "1037924560815",
      appId: "1:1037924560815:web:3ca426fb6f38243d40c95a"
    };

    // Inizializza Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Lista citt√† italiane (solo minuscolo per confronto)
    const ITALIAN_CITIES = [
      "abbiategrasso", "acireale", "adria", "agrigento", "alessandria", "ancona", "andria", "arezzo",
      "ascoli piceno", "asti", "avellino", "bari", "barletta", "belluno", "benevento", "bergamo",
      "biella", "bologna", "bolzano", "brescia", "brindisi", "cagliari", "caltanissetta", "campobasso",
      "caserta", "catania", "catanzaro", "chieti", "como", "cosenza", "cremona", "crotone", "cuneo",
      "empoli", "enna", "fermo", "ferrara", "firenze", "foggia", "forl√¨", "frosinone", "genova",
      "gorizia", "grosseto", "imperia", "isernia", "la spezia", "l'aquila", "latina", "lecce",
      "lecco", "livorno", "lodi", "lucca", "macerata", "mantova", "massa", "matera", "messina",
      "milano", "modena", "monza", "napoli", "novara", "nuoro", "olbia", "oristano", "padova",
      "palermo", "parma", "pavia", "perugia", "pesaro", "pescara", "piacenza", "pisa", "pistoia",
      "pordenone", "potenza", "prato", "ragusa", "ravenna", "reggio calabria", "reggio emilia",
      "rieti", "rimini", "roma", "rovigo", "salerno", "sassari", "savona", "siena", "siracusa",
      "sondrio", "taranto", "teramo", "terni", "torino", "trapani", "trento", "treviso", "trieste",
      "udine", "varese", "venezia", "verbania", "vercelli", "verona", "vibo valentia", "vicenza",
      "viterbo"
    ];

    // Estrai stanza e giocatore dall'URL
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room');
    const playerId = urlParams.get('player') || 'p' + Math.floor(Math.random() * 10000);

    if (!roomId) {
      roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
      window.history.replaceState(null, null, `?room=${roomId}&player=${playerId}`);
    }

    const roomRef = db.ref(`rooms/${roomId}`);

    // Stato iniziale
    let state = {
      letter: '',
      p1: { id: null, score: 0, answered: false },
      p2: { id: null, score: 0, answered: false },
      gameOver: false,
      winner: null,
      myAnswer: ''
    };

    // Unisciti o crea stanza
    roomRef.once('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        // Crea stanza
        const letters = 'ABCDEFGHILMNOPQRSTUVXZ';
        const letter = letters[Math.floor(Math.random() * letters.length)];
        roomRef.set({
          letter,
          p1: { id: playerId, score: 0, answered: false },
          p2: { id: null, score: 0, answered: false },
          gameOver: false,
          winner: null
        });
        state.p1.id = playerId;
      } else {
        if (!data.p1.id) {
          roomRef.child('p1/id').set(playerId);
          state.p1.id = playerId;
        } else if (!data.p2.id) {
          roomRef.child('p2/id').set(playerId);
          state.p2.id = playerId;
        } else if (data.p1.id === playerId) {
          state.p1.id = playerId;
        } else if (data.p2.id === playerId) {
          state.p2.id = playerId;
        } else {
          alert('Stanza piena!');
          return;
        }
      }
      syncAndRender();
    });

    // Ascolta aggiornamenti
    roomRef.on('value', syncAndRender);

    function syncAndRender(snapshot) {
      if (!snapshot) return;
      const data = snapshot.val();
      if (!data) return;

      state.letter = data.letter;
      state.p1 = data.p1;
      state.p2 = data.p2;
      state.gameOver = data.gameOver;
      state.winner = data.winner;

      render();
    }

    function checkAnswer() {
      const input = state.myAnswer.trim().toLowerCase();
      if (!input) {
        alert('Inserisci una citt√†!');
        return;
      }

      const isMyTurn = (state.p1.id === playerId && !state.p1.answered) ||
                       (state.p2.id === playerId && !state.p2.answered);
      if (!isMyTurn) return;

      const startsWithLetter = input[0].toUpperCase() === state.letter;
      const isCity = ITALIAN_CITIES.includes(input);

      const playerKey = state.p1.id === playerId ? 'p1' : 'p2';

      if (startsWithLetter && isCity) {
        roomRef.child(`${playerKey}/score`).transaction(s => (s || 0) + 1);
      }

      roomRef.child(`${playerKey}/answered`).set(true);

      // Controlla fine partita dopo 1.5s
      setTimeout(() => {
        roomRef.once('value', (snap) => {
          const d = snap.val();
          if (d.p1.answered && d.p2.answered) {
            if (d.p1.score >= 5 || d.p2.score >= 5) {
              roomRef.update({
                gameOver: true,
                winner: d.p1.score >= 5 ? 'p1' : 'p2'
              });
            } else {
              // Nuova lettera
              const letters = 'ABCDEFGHILMNOPQRSTUVXZ';
              const newLetter = letters[Math.floor(Math.random() * letters.length)];
              roomRef.update({
                letter: newLetter,
                'p1/answered': false,
                'p2/answered': false
              });
            }
          }
        });
      }, 1500);
    }

    function resetGame() {
      const letters = 'ABCDEFGHILMNOPQRSTUVXZ';
      const letter = letters[Math.floor(Math.random() * letters.length)];
      roomRef.set({
        letter,
        p1: { id: state.p1.id, score: 0, answered: false },
        p2: { id: state.p2.id, score: 0, answered: false },
        gameOver: false,
        winner: null
      });
    }

    function render() {
      const app = document.getElementById('app');
      const myPlayer = state.p1.id === playerId ? 'p1' : 'p2';
      const otherPlayer = myPlayer === 'p1' ? 'p2' : 'p1';

      if (state.gameOver) {
        const winnerName = state.winner === 'p1' ? 'Giocatore 1' : 'Giocatore 2';
        app.innerHTML = `
          <div class="bg-white p-6 rounded-2xl max-w-md w-full text-center shadow-xl">
            <h2 class="text-3xl font-bold mb-4">üèÜ ${winnerName} vince!</h2>
            <p class="text-lg mb-6">${state.p1.score} - ${state.p2.score}</p>
            <button onclick="resetGame()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
              Nuova partita
            </button>
            <p class="mt-4 text-sm text-gray-600">Condividi questo link:</p>
            <p class="text-xs text-gray-500 break-all">${window.location.href.split('&')[0]}</p>
          </div>
        `;
        return;
      }

      app.innerHTML = `
        <div class="bg-white p-6 rounded-2xl max-w-md w-full text-center shadow-xl">
          <div class="mb-4">
            <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">Stanza: ${roomId}</span>
          </div>
          <div class="flex justify-between mb-6 text-lg">
            <div class="font-bold ${myPlayer === 'p1' ? 'text-purple-600' : ''}">G1: ${state.p1.score}</div>
            <div class="font-bold ${myPlayer === 'p2' ? 'text-purple-600' : ''}">G2: ${state.p2.score}</div>
          </div>
          <div class="text-6xl font-bold mb-6 text-purple-600">${state.letter}</div>
          <p class="text-sm text-gray-600 mb-3">Inserisci una citt√† italiana che inizia con questa lettera</p>
          <input
            type="text"
            id="cityInput"
            placeholder="Es: Milano, Roma..."
            class="w-full p-3 border-2 border-gray-300 rounded-lg mb-3 focus:outline-none focus:border-purple-500"
            onkeypress="if(event.key==='Enter') checkAnswer()"
            ${state[myPlayer].answered ? 'disabled' : ''}
          />
          <button
            onclick="checkAnswer()"
            class="bg-pink-600 text-white w-full py-3 rounded-lg font-semibold hover:bg-pink-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
            ${state[myPlayer].answered ? 'disabled' : ''}
          >
            ${state[myPlayer].answered ? '‚úÖ Risposta inviata' : 'Invia risposta'}
          </button>
          <div class="mt-4 pt-4 border-t">
            <p class="text-sm ${state[otherPlayer].id ? 'text-green-600' : 'text-orange-600'}">
              ${state[otherPlayer].id ? '‚úÖ Avversario connesso' : '‚è≥ In attesa dell\'avversario...'}
            </p>
            ${!state[otherPlayer].id ? `<p class="text-xs text-gray-500 mt-2">Condividi il link per invitare qualcuno</p>` : ''}
          </div>
        </div>
      `;

      const input = document.getElementById('cityInput');
      if (input && !state[myPlayer].answered) {
        input.focus();
        input.addEventListener('input', e => state.myAnswer = e.target.value);
      }
    }
  </script>
</body>
</html>
